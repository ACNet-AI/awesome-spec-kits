name: Auto Register Speckit

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate-and-register:
    if: contains(github.event.issue.labels.*.name, 'registration')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout registry repo
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests toml pyyaml
      
      - name: Parse and validate speckit
        id: validate
        run: |
          python scripts/validate_speckit.py
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_OUTPUT: ${{ github.output }}
      
      - name: Update registry
        if: steps.validate.outputs.valid == 'true'
        run: |
          python scripts/add_to_registry.py \
            --name "${{ steps.validate.outputs.name }}" \
            --version "${{ steps.validate.outputs.version }}" \
            --description "${{ steps.validate.outputs.description }}" \
            --repository "${{ steps.validate.outputs.repository }}" \
            --pypi "${{ steps.validate.outputs.pypi_package }}" \
            --cli "${{ steps.validate.outputs.cli_command }}" \
            --license "${{ steps.validate.outputs.license }}" \
            --tags "${{ steps.validate.outputs.tags }}" \
            --registry speckits.json
      
      - name: Create Pull Request
        if: steps.validate.outputs.valid == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: add ${{ steps.validate.outputs.name }} to registry"
          branch: register-${{ steps.validate.outputs.name }}
          delete-branch: true
          title: "feat: register ${{ steps.validate.outputs.name }}"
          body: |
            ## ğŸš€ Auto-generated Registration
            
            Closes #${{ github.event.issue.number }}
            
            **Speckit**: `${{ steps.validate.outputs.name }}`  
            **Version**: `${{ steps.validate.outputs.version }}`  
            **Repository**: ${{ steps.validate.outputs.repository }}  
            **CLI**: `${{ steps.validate.outputs.cli_command }}`  
            **License**: ${{ steps.validate.outputs.license }}
            
            ### âœ… Validation Results
            
            ${{ steps.validate.outputs.summary }}
            
            ---
            
            *This PR was automatically generated by the registry bot.*
          labels: auto-registration
      
      - name: Comment on issue (success)
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Validation passed!**\n\nA PR has been created automatically. Maintainers will review and merge it soon.\n\n**Speckit**: `${{ steps.validate.outputs.name }}`\n**Version**: `${{ steps.validate.outputs.version }}`'
            })
      
      - name: Comment on issue (failure)
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Validation failed**\n\n${{ steps.validate.outputs.error }}\n\nPlease fix the issues and update this issue to trigger re-validation.'
            })

