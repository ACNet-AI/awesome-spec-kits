name: Auto Register Speckit

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate-and-register:
    # Trigger if issue has 'registration' label OR title starts with '[Register]'
    if: contains(github.event.issue.labels.*.name, 'registration') || startsWith(github.event.issue.title, '[Register]')
    runs-on: ubuntu-latest
    
    steps:
      - name: Add registration label if missing
        if: "!contains(github.event.issue.labels.*.name, 'registration')"
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['registration']
            })
      
      - name: Debug - Show issue info
        run: |
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Has registration label: ${{ contains(github.event.issue.labels.*.name, 'registration') }}"
          echo "Labels: ${{ toJson(github.event.issue.labels) }}"
      
      - name: Checkout registry repo
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests toml pyyaml
      
      - name: Parse and validate speckit
        id: validate
        run: |
          python scripts/validate_speckit.py
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
      
      - name: Update registry
        if: steps.validate.outputs.valid == 'true'
        id: update
        run: |
          python scripts/add_to_registry.py \
            --name "${{ steps.validate.outputs.name }}" \
            --version "${{ steps.validate.outputs.version }}" \
            --description "${{ steps.validate.outputs.description }}" \
            --repository "${{ steps.validate.outputs.repository }}" \
            --pypi "${{ steps.validate.outputs.pypi_package }}" \
            --cli "${{ steps.validate.outputs.cli_command }}" \
            --license "${{ steps.validate.outputs.license }}" \
            --tags "${{ steps.validate.outputs.tags }}" \
            --registry speckits.json
      
      - name: Create Pull Request
        if: steps.validate.outputs.valid == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "${{ steps.update.outputs.is_update == 'true' && format('chore: update {0} to v{1}', steps.validate.outputs.name, steps.validate.outputs.version) || format('feat: add {0} to registry', steps.validate.outputs.name) }}"
          branch: register-${{ steps.validate.outputs.name }}
          delete-branch: true
          title: "${{ steps.update.outputs.is_update == 'true' && format('chore: update {0} to v{1}', steps.validate.outputs.name, steps.validate.outputs.version) || format('feat: register {0}', steps.validate.outputs.name) }}"
          body: |
            ## ${{ steps.update.outputs.is_update == 'true' && 'ğŸ”„ Auto-generated Update' || 'ğŸš€ Auto-generated Registration' }}
            
            Closes #${{ github.event.issue.number }}
            
            **Speckit**: `${{ steps.validate.outputs.name }}`  
            **Version**: `${{ steps.validate.outputs.version }}`${{ steps.update.outputs.is_update == 'true' && format(' (was {0})', steps.update.outputs.old_version) || '' }}  
            **Repository**: ${{ steps.validate.outputs.repository }}  
            **CLI**: `${{ steps.validate.outputs.cli_command }}`  
            **License**: ${{ steps.validate.outputs.license }}
            ${{ steps.update.outputs.is_update == 'true' && format('
            ### ğŸ“ Changes
            
            {0}
            ', steps.update.outputs.changes) || '' }}
            ### âœ… Validation Results
            
            ${{ steps.validate.outputs.summary }}
            
            ---
            
            *This PR was automatically generated by the registry bot.*
          labels: auto-registration
      
      - name: Comment on issue (success)
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const isUpdate = '${{ steps.update.outputs.is_update }}' === 'true';
            const emoji = isUpdate ? 'ğŸ”„' : 'âœ…';
            const action = isUpdate ? 'Update' : 'Registration';
            const oldVersion = '${{ steps.update.outputs.old_version }}';
            const versionText = isUpdate ? `**Version**: \`${{ steps.validate.outputs.version }}\` (was ${oldVersion})` : `**Version**: \`${{ steps.validate.outputs.version }}\``;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} **Validation passed!**\n\nA PR for ${action.toLowerCase()} has been created automatically. Maintainers will review and merge it soon.\n\n**Speckit**: \`${{ steps.validate.outputs.name }}\`\n${versionText}`
            })
      
      - name: Comment on issue (failure)
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Validation failed**\n\n${{ steps.validate.outputs.error }}\n\nPlease fix the issues and update this issue to trigger re-validation.'
            })

